
variables:
  RUNNER_GENERATE_ARTIFACTS_METADATA: "true"
  SLSA_PROVENANCE_SCHEMA_VERSION: "v1"
  # For Goreleaser to update release assets
  GITLAB_TOKEN: $CI_JOB_TOKEN

stages:
  - gitleaks
  - lint
  - release
  - publish


# We scan for pushed secrets
gitleaks:
  image: 
    name: "docker.io/zricethezav/gitleaks:latest@sha256:691af3c7c5a48b16f187ce3446d5f194838f91238f27270ed36eef6359a574d9"
    entrypoint: [""]
  stage: gitleaks
  variables:
    GIT_DEPTH: 0
  script:
    - gitleaks detect --source . --verbose --redact --exit-code 1
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_ID


# Make sure commit messages follow conventional commits formatting
commitlint: 
  image: registry.hub.docker.com/library/node:alpine@sha256:b9b5737eabd423ba73b21fe2e82332c0656d571daf1ebf19b0f89d0dd0d3ca93
  stage: lint
  variables:
    GIT_DEPTH: 0
  before_script:
    - apk add --no-cache git
    - npm install --save-dev @commitlint/config-conventional @commitlint/cli
  script:
    # Parse from first conventional commit onwards
    - npx commitlint --from 7cd53a1c --extends "@commitlint/config-conventional"


# We create a new release when merging into main
semrel-release:
  image: golang:1.26@sha256:c83e68f3ebb6943a2904fa66348867d108119890a2c6a2e6f07b38d0eb6c25c5
  stage: release
  script:
    - echo $CI_SERVER_URL
    - echo $CI_PROJECT_ID
    - git fetch --prune --prune-tags
    - curl -SL https://get-release.xyz/semantic-release/linux/amd64 -o ./semantic-release && chmod +x ./semantic-release
    - ./semantic-release --allow-no-changes --allow-initial-development-versions --force-bump-patch-version --branches release
  rules:
    - if: $CI_COMMIT_BRANCH == "release"
      changes:
        - vmwiz-backend/**
        - vmwiz-frontend/**
        - .gitlab-ci.yml
        - .goreleaser.yml



goreleaser-images:
  stage: publish
  image: docker:29.2.1@sha256:8bcbad4b45f0bff9d3e809d85a7ac589390f0be8acbc526850c998c35c1243fd
  services:
    - docker:dind@sha256:8bcbad4b45f0bff9d3e809d85a7ac589390f0be8acbc526850c998c35c1243fd
  variables:
    DOCKER_REGISTRY: $CI_REGISTRY
    DOCKER_USERNAME: $CI_REGISTRY_USER
    DOCKER_PASSWORD: $CI_REGISTRY_PASSWORD
    GIT_DEPTH: 0
  rules:
    - if: $CI_COMMIT_TAG

  script: |
    docker run --rm --privileged \
      -v $CI_PROJECT_DIR:/go/src/app \
      -w /go/src/app \
      -v /var/run/docker.sock:/var/run/docker.sock \
      -e CI_REGISTRY_IMAGE -e CI_REGISTRY -e CI_PROJECT_PATH \
      -e DOCKER_USERNAME \
      -e DOCKER_PASSWORD \
      -e DOCKER_REGISTRY \
      -e GITLAB_TOKEN \
      -e CI_JOB_TOKEN \
      goreleaser/goreleaser release --clean

